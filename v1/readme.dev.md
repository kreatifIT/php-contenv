# Developer Guide: php-contenv

## 1. Introduction

This document serves as the comprehensive technical guide for developers contributing to or maintaining the `php-contenv` project. It provides a "nano-detail" breakdown of the project's architecture, scripts, workflows, and development philosophy. The primary `readme.md` is for end-users; this guide is for us, the builders.

## 2. Core Philosophy

The project is built on four pillars:

1.  **Simplicity:** The end-user experience should be as simple as running a single command (`docky setup`). The complexity of Docker should be abstracted away.
2.  **Consistency:** Provide a consistent and predictable environment across different PHP versions and web servers.
3.  **Speed:** Development environments should be fast. This means fast initial setup and fast rebuilds. This is the primary motivation for moving from local builds to pre-built Docker images.
4.  **Flexibility:** While providing sensible defaults (especially for Laravel), the system should be flexible enough to be used for any PHP project and easily extendable with additional services.

## 3. Directory and File Structure

Every file and directory has a specific purpose.

-   `/`: Project root.
    -   `.gitignore`: Standard Git ignore file for the project itself.
    -   `LICENSE`: The MIT License file.
    -   `readme.md`: The user-facing documentation.
    -   `readme.dev.md`: **This file.** The developer-facing documentation.
    -   `docky`: The main entry point for the user. A bash script responsible for scaffolding the `docker-compose.yml` and providing user guidance.

-   `/[0-9].*/` (e.g., `8.1/`, `8.2/`):
    -   **Purpose:** Houses the Dockerfiles for each specific major PHP version. This separation allows for version-specific dependencies or build steps.
    -   `apache/Dockerfile`: Dockerfile for the Apache variant of that PHP version.
    -   `nginx/Dockerfile`: Dockerfile for the Nginx (PHP-FPM) variant of that PHP version.

-   `/common/`:
    -   **Purpose:** Contains configuration files and scripts shared across all Docker images, regardless of PHP version or web server. This is crucial for maintainability (Don't Repeat Yourself).
    -   `install-nvm.sh`: A script to install Node Version Manager (NVM), Node.js, and NPM inside the containers.
    -   `start-container`: The entrypoint script for all containers. It sets up permissions and starts the main `supervisord` process.
    -   `supervisord.apache.conf`: Supervisor configuration for Apache containers. It manages the Apache process.
    -   `supervisord.nginx.conf`: Supervisor configuration for Nginx containers. It manages the Nginx and PHP-FPM processes.
    -   `apache-conf/`: Apache-specific configurations (`apache2.conf`, `default.conf`).
    -   `nginx-conf/`: Nginx-specific configurations (`nginx.conf`, `default.conf`).
    -   `php/`: Shared PHP configurations.
        -   `php.ini`: A custom `php.ini` with common development settings.
        -   `20-xdebug.ini`: The configuration file for the Xdebug extension.

-   `/database/`:
    -   **Purpose:** Contains helper scripts for initializing databases within their respective containers. These are typically mounted as volumes and run on container startup.
    -   `mariadb/`, `mysql/`, `pgsql/`: Each contains scripts like `create-testing-database.sh` to automate database setup.

-   `/public/`:
    -   **Purpose:** Contains a simple `index.php` file. This is used as a placeholder and allows a user to immediately see a working page after setup, confirming the environment is running correctly.

-   `/scripts/`:
    -   **Purpose:** Contains utility scripts for the maintainers of `php-contenv`.
    -   `build-images.sh`: **(New)** A critical script that automates the building and tagging of all Docker image variants.

-   `/stubs/`:
    -   **Purpose:** Contains templates or "stubs" for generating the final `docker-compose.yml` file. This is the core of the `docky` script's generation process.
    -   `.gitignore.stub`: A template for the `.gitignore` entries the user should add to their project.
    -   `services/`: Contains YAML snippets for each service.
        -   `app-service.stub.yml`: The template for the main PHP application service.
        -   `[service]-service.stub.yml`: Templates for optional services like `mysql`, `redis`, `mailpit`, etc.

-   `/tests/`:
    -   **Purpose:** Contains `docker-compose` files used for internal testing of the `php-contenv` project itself, ensuring that each image variant builds and runs correctly.

## 4. The `docky` Script: A Deep Dive

The `docky` script is a bash script that acts as a command-line wizard.

#### Commands

-   `setup`: The main command. It guides the user through a series of questions to generate a tailored `docker-compose.yml`.
-   `add-service <service_name>`: A utility to add a new service to an existing `docker-compose.yml` generated by `docky`.

#### Internal Logic (`setup`)

1.  **Pre-flight Checks:** It first checks if `docker` and `docker compose` (or `docker-compose`) are installed.
2.  **Directory Scanning:** It dynamically finds available PHP versions and web servers by scanning the directory structure (e.g., `ls -d .docker/[0-9]*.[0-9]*`). This makes the script automatically aware of new versions or servers you add.
3.  **User Interaction:** It uses `select` and `read` to prompt the user for:
    -   PHP Version
    -   Web Server
    -   Docker Network Name
    -   Optional services (by iterating through the files in `stubs/services/`).
4.  **`generate_docker_compose` Function:** This is the heart of the script.
    -   It initializes a string variable with the header of the `docker-compose.yml` file.
    -   It reads the content of `stubs/services/app-service.stub.yml`.
    -   **Image Tag Replacement:** It uses `sed` to replace the `__IMAGE_TAG__` placeholder in the stub with the final image tag, constructed from the user's selections (e.g., `8.4-nginx-v1.0.0`).
    -   It appends the modified app service to the main string.
    -   It loops through the user's selected optional services, reads the content of the corresponding stub file (e.g., `mysql-service.stub.yml`), and appends it.
    -   It appends the final `networks` and `volumes` sections.
    -   Finally, it writes the complete string to `docker-compose.yml` in the project root.
5.  **Post-generation Guidance:** It prints helpful messages telling the user what to add to their `.env` and `.gitignore` files and how to start the environment.

## 5. Docker Image Management Workflow

This is the most significant recent change to the project, moving from a build-on-demand model to a pre-built image model.

#### Image Naming Convention

-   **Repository:** All images are stored in a single Docker Hub repository: `techgonia-devjio/php-contenv`.
-   **Tag Format:** `[php-version]-[web-server]-v[project-version]`
    -   `[php-version]`: e.g., `8.1`, `8.4`
    -   `[web-server]`: e.g., `apache`, `nginx`
    -   `[project-version]`: A semantic version for `php-contenv` itself (e.g., `1.0.0`). **This is critical.**

#### The `scripts/build-images.sh` Script

-   **Purpose:** To build all 8 image variants (`4 versions * 2 servers`) and tag them correctly according to the convention.
-   **How it works:**
    -   It defines the `USERNAME`, `REPOSITORY`, and `VERSION` variables at the top.
    -   It uses two nested `for` loops to iterate through each PHP version and web server.
    -   Inside the loop, it constructs the tag and runs the `docker build` command, pointing to the correct Dockerfile.

#### Publishing Workflow

1.  **Modify Code:** Make changes to a Dockerfile or a file in `/common`.
2.  **Increment Version:** **IMPORTANT:** Open `scripts/build-images.sh` and increment the `VERSION` variable (e.g., from `1.0.0` to `1.0.1`). This signals a new release of the images.
3.  **Update `docky`:** Open the `docky` script and update the version number in the `generate_docker_compose` function to match the new version from the build script.
4.  **Build:** Make the script executable (`chmod +x scripts/build-images.sh`) and run it (`./scripts/build-images.sh`).
5.  **Login:** Log in to Docker Hub: `docker login`.
6.  **Push:** Push each image to the registry. You must do this for all variants.
    ```bash
    # Example for one image
    docker push techgonia-devjio/php-contenv:8.4-apache-v1.0.1
    # ...repeat for all other images
    ```

## 6. How to Contribute

#### Adding a New PHP Version (e.g., 9.0)

1.  Create the directories: `mkdir -p 9.0/apache 9.0/nginx`.
2.  Copy the `Dockerfile` from an existing version (e.g., `8.4`) into the new directories.
3.  Edit the new Dockerfiles (`9.0/apache/Dockerfile` and `9.0/nginx/Dockerfile`) and change the `FROM` instruction to `php:9.0-apache` or `php:9.0-fpm`.
4.  Edit `scripts/build-images.sh` and add `9.0` to the `for PHP_VERSION in ...` loop.
5.  Follow the **Publishing Workflow** above (increment version, build, push). The `docky` script will automatically detect the new version because it scans the directories.

#### Adding FrankenPHP Support

1.  For each PHP version (`8.2`, `8.3`, etc.), create a `frankenphp` directory: `mkdir 8.2/frankenphp`.
2.  Create the `Dockerfile` for each new variant. This will likely use a FrankenPHP base image and copy in the relevant `common` files.
3.  Create a new supervisor config in `common/supervisord.frankenphp.conf`.
4.  Edit `scripts/build-images.sh` and add `frankenphp` to the `for WEB_SERVER in ...` loop.
5.  Follow the **Publishing Workflow**. `docky` will automatically pick it up as a new server option.

## 7. Future Improvements

-   **`push-images.sh` script:** Create a script that automates the `docker push` process for all image variants.
-   **YAML Parser in `docky`:** The script currently uses `sed` and `awk` to manipulate YAML, which is fragile. For more complex changes, replacing this with a dedicated CLI YAML parser like `yq` would make the script more robust and readable.
-   **Automated Testing:** Implement a test suite (e.g., using `bats-core`) that runs `docky setup` for each combination, runs `docker compose up`, and curls the resulting container to ensure it's serving correctly. This would be run before publishing new images.
